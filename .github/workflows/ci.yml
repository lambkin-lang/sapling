name: CI

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    - cron: "0 7 * * *"

jobs:
  test-and-bench:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    env:
      WASM_TOOLS_VERSION: 1.245.1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: ${{ runner.os }}-cargo-wasm-tools-${{ env.WASM_TOOLS_VERSION }}
          restore-keys: |
            ${{ runner.os }}-cargo-wasm-tools-

      - name: Install dependencies
        run: |
          # Use retry for apt-get
          for i in {1..5}; do sudo apt-get update && break || sleep 5; done
          sudo apt-get install -y cppcheck clang clang-format clang-tidy curl
          
          # Install wasm-tools from binary release (much faster than building from source)
          set -euo pipefail
          URL="https://github.com/bytecodealliance/wasm-tools/releases/download/v${WASM_TOOLS_VERSION}/wasm-tools-${WASM_TOOLS_VERSION}-x86_64-linux.tar.gz"
          curl -L "$URL" | tar xz
          sudo mv wasm-tools-${WASM_TOOLS_VERSION}-x86_64-linux/wasm-tools /usr/local/bin/
          wasm-tools --version

      - name: Build and test
        run: make test CC=clang

      - name: Phase-0 schema and harness checks
        run: make schema-check stress-harness CC=clang CLANG_FORMAT=clang-format CLANG_TIDY=clang-tidy WASM_TOOLS=wasm-tools

      - name: Code Quality Checks (Lint)
        run: make lint CC=clang CLANG_FORMAT=clang-format CLANG_TIDY=clang-tidy

      - name: Runner phase checks
        run: make phasec-check CC=clang CLANG_FORMAT=clang-format CLANG_TIDY=clang-tidy WASM_TOOLS=wasm-tools

      - name: Benchmark regression guardrail
        run: |
          echo "CPU Info:"
          grep "model name" /proc/cpuinfo | head -n 1 || true
          uptime
          make bench-ci BENCH_COUNT=100000 BENCH_ROUNDS=3 CC=clang

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-failure-logs
          path: |
            build/
            *.log
            benchmarks/

  seq-fuzz-smoke:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y clang llvm
          clang --version

      - name: Seq fuzz smoke
        run: |
          mkdir -p .fuzz-corpus/seq
          make seq-fuzz \
            CC=clang \
            CXX=clang++ \
            LLVM_SYMBOLIZER="$(command -v llvm-symbolizer || true)" \
            SEQ_FUZZ_RUNS=5000 \
            SEQ_FUZZ_MAX_LEN=1024 \
            SEQ_FUZZ_CORPUS=.fuzz-corpus/seq

  text-fuzz-smoke:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y clang llvm
          clang --version

      - name: Text fuzz smoke
        run: |
          mkdir -p .fuzz-corpus/text
          make text-fuzz \
            CC=clang \
            CXX=clang++ \
            LLVM_SYMBOLIZER="$(command -v llvm-symbolizer || true)" \
            TEXT_FUZZ_RUNS=5000 \
            TEXT_FUZZ_MAX_LEN=1024 \
            TEXT_FUZZ_CORPUS=.fuzz-corpus/text

  seq-fuzz-scheduled:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y clang llvm
          clang --version

      - name: Seq fuzz long run
        run: |
          mkdir -p .fuzz-corpus/seq
          make seq-fuzz \
            CC=clang \
            CXX=clang++ \
            LLVM_SYMBOLIZER="$(command -v llvm-symbolizer || true)" \
            SEQ_FUZZ_RUNS=250000 \
            SEQ_FUZZ_MAX_LEN=4096 \
            SEQ_FUZZ_CORPUS=.fuzz-corpus/seq

      - name: Upload seq fuzz corpus
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: seq-fuzz-corpus-${{ github.run_id }}
          path: .fuzz-corpus/seq
          if-no-files-found: ignore

  text-fuzz-scheduled:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y clang llvm
          clang --version

      - name: Text fuzz long run
        run: |
          mkdir -p .fuzz-corpus/text
          make text-fuzz \
            CC=clang \
            CXX=clang++ \
            LLVM_SYMBOLIZER="$(command -v llvm-symbolizer || true)" \
            TEXT_FUZZ_RUNS=250000 \
            TEXT_FUZZ_MAX_LEN=4096 \
            TEXT_FUZZ_CORPUS=.fuzz-corpus/text

      - name: Upload text fuzz corpus
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: text-fuzz-corpus-${{ github.run_id }}
          path: .fuzz-corpus/text
          if-no-files-found: ignore
